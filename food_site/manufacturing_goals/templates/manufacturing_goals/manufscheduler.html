{% extends "base.html" %}
{% load static %}
{% block content %}
	<link rel="stylesheet" type="text/css" href="{% static 'manufacturing_goals/vis.min.css' %}">
	<script type="text/javascript" src="{% static 'manufacturing_goals/vis.min.js' %}"></script>
	<style>
		li::before {
			content: "+";
			padding-right: 8px;
			color: blue;
		}
	</style>
	<div id="visualization" style="padding:10px;"></div>
	<div class='items-panel'>
		<div class='side'>
			<!-- This should pull from the db -->
			<h3>Items:</h3>
			<ul class="items" style="list-style: none;">
				<!-- there should be a way to change the coloration here -->
				<!-- as well as a second change if deleted on timeline -->
				<!-- literally cannot get drag&drop working. I think it's busted on visjs' side -->
				<li class="item" id="activity-2" onclick="addToTimeline('item 2')">item 2</li>
				<li class="item" id="activity-3" onclick="addToTimeline('item 3')">item 3</li>
			</ul>
		</div>
	</div>
	<!--<button onclick="saveTLData()">Save Timeline</button>-->
	<form class="form-inline" method="POST" action="/manufacturing/timeline/">
		{% csrf_token %}
		<input value="{{ data }}" type="text" name="data" id="data" required="required" placeholder="[]" style="display:none;">
		<button type="submit" onclick="saveTLData()">Save Timeline</button>
	</form>
	<script type="text/javascript">
		var container = document.getElementById('visualization');
		// eventually want this to be pulled from the database of manufacturing lines
		var groups = new vis.DataSet([
			{id: 1, content: 'group 1'}
		]);
		// and this from the manufacturing goals/activities?
		var items = new vis.DataSet([
			{id: 1, content: 'item 1', start: '2019-02-22', end: '2019-02-23', group: 1}
		]);
		var nextItem = 2;
		// want moveable, clickable, extendable, removeable and replaceable, but not changeable
		// also may want to consider hiding non-business hours?
		var today = new Date();
		var dd = today.getDate();
		var d2 = today.getDate() +1;
		var mm = today.getMonth() + 1;
		var yyyy = today.getFullYear();
		if (dd < 10){dd='0'+dd;}
		if (d2 < 10){d2='0'+d2;}
		if (mm < 10){mm='0'+mm;}
		today = mm+'/'+dd+'/'+yyyy;
		tomorrow = mm+'/'+d2+'/'+yyyy;
		var options = {
			stack: true,
			selectable: true,
			editable: {
				add: false,
				remove: true,
				updateGroup: true,
				updateTime: true,
				overrideItems: false
			},
			timeAxis: {
				scale: 'hour',
				step: 1
			},
			type: 'range',
			start: today,
			end: tomorrow,
			onDropObjectOnItem: function(objectData, item, callback) {
				if (!item){ return; }
				alert('dropped object: "' + objectData.content + '" on item: "' + item.content + '"');
			}
		};
		var timeline = new vis.Timeline(container, items, groups, options);
		var now = new Date();
		var visibleStart = new Date(now.getFullYear(),now.getMonth(),now.getDate(), 0, 0, 0, 0);
		timeline.on('rangechange', function(properties) {
			visibleStart = properties.start;
		});
		//timeline.on('mouseOver', function(properties) {
		//	visibleStart = properties.start;
		//});

		//var modal = document.getElementById('addActivityModal');
		//var closer = document.getElementsByClassName("close")[0];
		function addToTimeline(id){
			// actual ids on the timeline should be generated on the fly
			//document.getElementById('activityID').innerHTML = id;
			//modal.style.display = "block";
			// presumably group will also be determined by db
			//console.log(visibleStart);
			items.add([{id: nextItem, content: id, start: visibleStart, end: new Date(visibleStart.getFullYear(), visibleStart.getMonth(), visibleStart.getDate(), visibleStart.getHours() + 1, visibleStart.getMinutes(), 0, 0), type: 'range', group: 1}]);
			nextItem++;
		}

		function saveTLData() {
			var data = items.get({
				type: {
					start: 'ISODate',
					end: 'ISODate'
				}
			});
			document.getElementById("data").value = JSON.stringify(data, null, 2);
			//console.log(JSON.stringify(data, null, 2));
		}
		// also need to load data from db
	</script>
{% endblock content %}
